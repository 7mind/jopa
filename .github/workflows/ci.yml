name: Jopa CI

on:
  push:
    branches: [ main, master, develop, 'wip/**' ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-release:
    name: Build and Test (Release)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14
        with:
          logger: pretty
          log-directives: nix_installer=debug

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Check flake
        run: nix flake check --show-trace

      - name: Configure with CMake (Release)
        run: |
          nix develop --command bash -c "
            cmake -S . -B build \
              -DCMAKE_BUILD_TYPE=Release \
              -DJOPA_ENABLE_SANITIZERS=OFF \
              -DJOPA_ENABLE_CPPTRACE=OFF
          "

      - name: Build Jopa
        run: |
          nix develop --command bash -c "
            cmake --build build -j\$(nproc)
          "

      - name: Run Primary Tests
        run: |
          nix develop --command bash -c "
            cd build
            ctest --output-on-failure -j\$(nproc) -E '^parse_'
          "

      - name: Generate test summary
        if: always()
        run: |
          nix develop --command bash -c "
            cd build
            echo '## Release Build Test Results' >> \$GITHUB_STEP_SUMMARY
            echo '' >> \$GITHUB_STEP_SUMMARY
            echo '### Primary Test Summary' >> \$GITHUB_STEP_SUMMARY
            echo '' >> \$GITHUB_STEP_SUMMARY
            echo '\`\`\`' >> \$GITHUB_STEP_SUMMARY
            ctest -E '^parse_' 2>&1 | tail -20 >> \$GITHUB_STEP_SUMMARY || true
            echo '\`\`\`' >> \$GITHUB_STEP_SUMMARY
          "

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-release
          path: |
            build/test/*.class
            build/Testing/Temporary/LastTest.log
          retention-days: 7

  build-debug:
    name: Build and Test (Debug + Sanitizers)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14
        with:
          logger: pretty
          log-directives: nix_installer=debug

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Configure with CMake (Debug)
        run: |
          nix develop --command bash -c "
            cmake -S . -B build \
              -DCMAKE_BUILD_TYPE=Debug \
              -DJOPA_ENABLE_SANITIZERS=ON \
              -DJOPA_ENABLE_CPPTRACE=ON
          "

      - name: Build Jopa
        run: |
          nix develop --command bash -c "
            cmake --build build -j\$(nproc)
          "

      - name: Run Primary Tests with Sanitizers
        run: |
          nix develop --command bash -c "
            cd build
            ctest --output-on-failure -j\$(nproc) -E '^parse_'
          "

      - name: Generate test summary
        if: always()
        run: |
          nix develop --command bash -c "
            cd build
            echo '## Debug Build Test Results (with Sanitizers)' >> \$GITHUB_STEP_SUMMARY
            echo '' >> \$GITHUB_STEP_SUMMARY
            echo '### Primary Test Summary' >> \$GITHUB_STEP_SUMMARY
            echo '' >> \$GITHUB_STEP_SUMMARY
            echo '\`\`\`' >> \$GITHUB_STEP_SUMMARY
            ctest -E '^parse_' 2>&1 | tail -20 >> \$GITHUB_STEP_SUMMARY || true
            echo '\`\`\`' >> \$GITHUB_STEP_SUMMARY
          "

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-debug
          path: |
            build/test/*.class
            build/Testing/Temporary/LastTest.log
          retention-days: 7

  parser-tests-jdk7:
    name: JDK7 Parser Tests
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14
        with:
          logger: pretty
          log-directives: nix_installer=debug

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Configure with CMake
        run: |
          nix develop --command bash -c "
            cmake -S . -B build \
              -DCMAKE_BUILD_TYPE=Release \
              -DJOPA_ENABLE_SANITIZERS=OFF \
              -DJOPA_ENABLE_CPPTRACE=OFF \
              -DJOPA_ENABLE_JDK_PARSER_TESTS=ON \
              -DJOPA_PARSER_TESTS_JDK7=ON \
              -DJOPA_PARSER_TESTS_JDK8=OFF
          "

      - name: Build Jopa
        run: |
          nix develop --command bash -c "
            cmake --build build -j\$(nproc)
          "

      - name: Run JDK7 Parser Tests
        id: parser_tests
        run: |
          nix develop --command bash -c "
            cd build
            # Run tests in parallel, capture results
            ctest -R '^parse_jdk7_' -j\$(nproc) --output-on-failure 2>&1 | tee parser_results.txt || true

            # Extract statistics using ctest -N for total count
            TOTAL=\$(ctest -R '^parse_jdk7_' -N 2>/dev/null | grep 'Total Tests:' | sed 's/Total Tests: //' || echo 0)
            # Extract failed count from 'X tests failed out of Y' format
            FAILED=\$(grep -E '[0-9]+ tests failed' parser_results.txt | sed 's/.*\\b\\([0-9]\\+\\) tests failed.*/\\1/' | head -1 || echo 0)
            PASSED=\$((\$TOTAL - \$FAILED))

            echo \"total=\$TOTAL\" >> \$GITHUB_OUTPUT
            echo \"passed=\$PASSED\" >> \$GITHUB_OUTPUT
            echo \"failed=\$FAILED\" >> \$GITHUB_OUTPUT
          "

      - name: Generate parser test summary
        if: always()
        run: |
          nix develop --command bash -c "
            cd build
            echo '## JDK7 Parser Test Results' >> \$GITHUB_STEP_SUMMARY
            echo '' >> \$GITHUB_STEP_SUMMARY

            # Count tests using 'Total Tests: N' format
            TOTAL=\$(ctest -R '^parse_jdk7_' -N 2>/dev/null | grep 'Total Tests:' | sed 's/Total Tests: //' || echo 'N/A')

            # Get pass/fail from last run
            if [ -f parser_results.txt ]; then
              echo \"| Metric | Count |\" >> \$GITHUB_STEP_SUMMARY
              echo \"|--------|-------|\" >> \$GITHUB_STEP_SUMMARY
              echo \"| Total Tests | \$TOTAL |\" >> \$GITHUB_STEP_SUMMARY
              # Extract failed count from 'X tests failed out of Y' format
              FAILED=\$(grep -E '[0-9]+ tests failed' parser_results.txt | sed 's/.*\\b\\([0-9]\\+\\) tests failed.*/\\1/' | head -1 || echo 0)
              PASSED=\$((\$TOTAL - \${FAILED:-0}))
              echo \"| Passed | \$PASSED |\" >> \$GITHUB_STEP_SUMMARY
              echo \"| Failed | \${FAILED:-0} |\" >> \$GITHUB_STEP_SUMMARY
            fi

            echo '' >> \$GITHUB_STEP_SUMMARY
            echo '### Last 30 lines of output' >> \$GITHUB_STEP_SUMMARY
            echo '\`\`\`' >> \$GITHUB_STEP_SUMMARY
            tail -30 parser_results.txt >> \$GITHUB_STEP_SUMMARY 2>/dev/null || echo 'No results available'
            echo '\`\`\`' >> \$GITHUB_STEP_SUMMARY
          "

  parser-tests-jdk8:
    name: JDK8 Parser Tests
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14
        with:
          logger: pretty
          log-directives: nix_installer=debug

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Configure with CMake
        run: |
          nix develop --command bash -c "
            cmake -S . -B build \
              -DCMAKE_BUILD_TYPE=Release \
              -DJOPA_ENABLE_SANITIZERS=OFF \
              -DJOPA_ENABLE_CPPTRACE=OFF \
              -DJOPA_ENABLE_JDK_PARSER_TESTS=ON \
              -DJOPA_PARSER_TESTS_JDK7=OFF \
              -DJOPA_PARSER_TESTS_JDK8=ON
          "

      - name: Build Jopa
        run: |
          nix develop --command bash -c "
            cmake --build build -j\$(nproc)
          "

      - name: Run JDK8 Parser Tests
        id: parser_tests
        run: |
          nix develop --command bash -c "
            cd build
            # Run tests in parallel, capture results
            ctest -R '^parse_jdk8_' -j\$(nproc) --output-on-failure 2>&1 | tee parser_results.txt || true

            # Extract statistics using ctest -N for total count
            TOTAL=\$(ctest -R '^parse_jdk8_' -N 2>/dev/null | grep 'Total Tests:' | sed 's/Total Tests: //' || echo 0)
            # Extract failed count from 'X tests failed out of Y' format
            FAILED=\$(grep -E '[0-9]+ tests failed' parser_results.txt | sed 's/.*\\b\\([0-9]\\+\\) tests failed.*/\\1/' | head -1 || echo 0)
            PASSED=\$((\$TOTAL - \$FAILED))

            echo \"total=\$TOTAL\" >> \$GITHUB_OUTPUT
            echo \"passed=\$PASSED\" >> \$GITHUB_OUTPUT
            echo \"failed=\$FAILED\" >> \$GITHUB_OUTPUT
          "

      - name: Generate parser test summary
        if: always()
        run: |
          nix develop --command bash -c "
            cd build
            echo '## JDK8 Parser Test Results' >> \$GITHUB_STEP_SUMMARY
            echo '' >> \$GITHUB_STEP_SUMMARY

            # Count tests using 'Total Tests: N' format
            TOTAL=\$(ctest -R '^parse_jdk8_' -N 2>/dev/null | grep 'Total Tests:' | sed 's/Total Tests: //' || echo 'N/A')

            # Get pass/fail from last run
            if [ -f parser_results.txt ]; then
              echo \"| Metric | Count |\" >> \$GITHUB_STEP_SUMMARY
              echo \"|--------|-------|\" >> \$GITHUB_STEP_SUMMARY
              echo \"| Total Tests | \$TOTAL |\" >> \$GITHUB_STEP_SUMMARY
              # Extract failed count from 'X tests failed out of Y' format
              FAILED=\$(grep -E '[0-9]+ tests failed' parser_results.txt | sed 's/.*\\b\\([0-9]\\+\\) tests failed.*/\\1/' | head -1 || echo 0)
              PASSED=\$((\$TOTAL - \${FAILED:-0}))
              echo \"| Passed | \$PASSED |\" >> \$GITHUB_STEP_SUMMARY
              echo \"| Failed | \${FAILED:-0} |\" >> \$GITHUB_STEP_SUMMARY
            fi

            echo '' >> \$GITHUB_STEP_SUMMARY
            echo '### Last 30 lines of output' >> \$GITHUB_STEP_SUMMARY
            echo '\`\`\`' >> \$GITHUB_STEP_SUMMARY
            tail -30 parser_results.txt >> \$GITHUB_STEP_SUMMARY 2>/dev/null || echo 'No results available'
            echo '\`\`\`' >> \$GITHUB_STEP_SUMMARY
          "
