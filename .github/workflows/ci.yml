name: Jikes Java 5 CI

on:
  push:
    branches: [ main, master, develop, wip/cmake ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: Build and Test Jikes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14
        with:
          logger: pretty
          log-directives: nix_installer=debug

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Check flake
        run: nix flake check --show-trace

      - name: Configure with CMake
        run: |
          nix develop --command bash -c "
            cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DJIKES_ENABLE_SOURCE_15=ON
          "

      - name: Build Jikes
        run: |
          nix develop --command bash -c "
            cmake --build build -j$(nproc)
          "

      - name: Run CTest
        run: |
          nix develop --command bash -c "
            cd build
            ctest --output-on-failure --verbose
          "

      - name: Generate test summary
        if: always()
        run: |
          nix develop --command bash -c "
            cd build
            echo '## Test Results' >> $GITHUB_STEP_SUMMARY
            echo '' >> $GITHUB_STEP_SUMMARY
            echo '### CTest Summary' >> $GITHUB_STEP_SUMMARY
            echo '' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ctest --output-on-failure 2>&1 | tail -20 >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          "

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            build/test-generics/*.class
            build/Testing/Temporary/LastTest.log
          retention-days: 7

  build-legacy:
    name: Build with Autoconf (Legacy)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Build with Autoconf
        run: |
          nix develop --command bash -c "
            ./configure --enable-source15
            make -j$(nproc)
          "

      - name: Run legacy tests
        run: |
          nix develop --command bash -c "
            make check || true
          "

  check-java5-features:
    name: Java 5 Feature Matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        feature:
          - name: "Generics"
            test: "test-generics/GenericTest.java"
            class: "GenericTest"
          - name: "Enums"
            test: "test-generics/ColorTest.java"
            class: "ColorTest"
          - name: "Varargs"
            test: "test-generics/VarargsTest.java"
            class: "VarargsTest"
          - name: "Enhanced For"
            test: "test-generics/ForEachTest.java"
            class: "ForEachTest"
          - name: "Autoboxing"
            test: "test-generics/BasicBoxingTest.java"
            class: "BasicBoxingTest"
          - name: "Static Imports"
            test: "test-generics/StaticFieldOnlyTest.java"
            class: "StaticFieldOnlyTest"
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Build Jikes
        run: |
          nix develop --command bash -c "
            cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DJIKES_ENABLE_SOURCE_15=ON
            cmake --build build -j$(nproc)
          "

      - name: Compile runtime classes
        run: |
          nix develop --command bash -c "
            mkdir -p test-output
            ./build/src/jikes -source 1.5 -sourcepath test-generics/runtime -d test-generics/runtime \
              test-generics/runtime/java/util/Iterator.java \
              test-generics/runtime/java/lang/Iterable.java \
              test-generics/runtime/java/util/ArrayList.java || true
          "

      - name: Test ${{ matrix.feature.name }}
        run: |
          nix develop --command bash -c "
            mkdir -p test-output
            ./build/src/jikes -source 1.5 -sourcepath test-generics/runtime:test-generics -classpath test-generics/runtime -d test-output ${{ matrix.feature.test }}
            java -cp test-output:test-generics/runtime ${{ matrix.feature.class }}
          "
