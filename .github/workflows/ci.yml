name: Jopa CI

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  # Quick check - just build and test JOPA compiler
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        variant: [release, debug]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Build and test JOPA (${{ matrix.variant }})
        run: |
          if [ "${{ matrix.variant }}" = "debug" ]; then
            nix build .#jopa-debug --print-build-logs
          else
            nix build .#jopa --print-build-logs
          fi

      - name: Generate test summary
        if: always()
        run: |
          echo "## ${{ matrix.variant }} Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -L result ]; then
            echo "Build successful: $(readlink result)" >> $GITHUB_STEP_SUMMARY
          else
            echo "Build failed" >> $GITHUB_STEP_SUMMARY
          fi

  # Build DevJopaK distributions
  build-devjopak:
    name: Build DevJopaK
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          - name: devjopak-gnucp099-jopa201
            artifact: devjopak-jopa
          - name: devjopak-gnucp099-ecj421
            artifact: devjopak-ecj421
          - name: devjopak-gnucp099-ecj422
            artifact: devjopak-ecj422

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Build ${{ matrix.name }}
        run: |
          nix build .#${{ matrix.name }} --print-build-logs

          # Verify the build
          echo "Build output:"
          ls -la result/

          # Test basic functionality
          export PATH="$(pwd)/result/bin:$PATH"
          java -version
          javac -version || javac -help | head -1

      - name: Create distribution tarball
        run: |
          # Create tarball from nix output
          VERSION="2.0.1"
          TARBALL="${{ matrix.name }}-${VERSION}.tar.gz"

          mkdir -p dist
          cp -rL result dist/${{ matrix.name }}
          cd dist
          tar -czf "../${TARBALL}" ${{ matrix.name }}
          cd ..

          echo "Created: ${TARBALL}"
          ls -la "${TARBALL}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.name }}-*.tar.gz
          retention-days: 30

  # Parser tests
  parser-tests:
    name: Parser Tests
    runs-on: ubuntu-latest
    needs: build-and-test
    strategy:
      matrix:
        include:
          - jdk: 7
            threshold: 97.5
          - jdk: 8
            threshold: 92.8

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Run JDK${{ matrix.jdk }} Parser Tests
        run: |
          nix develop --command bash ./scripts/test-java${{ matrix.jdk }}-parser.sh --build

      - name: Check Success Threshold (${{ matrix.threshold }}%)
        run: |
          source build/parser_jdk${{ matrix.jdk }}_results.env
          echo "JDK${{ matrix.jdk }} Parser Results:"
          echo "  Passed: ${PARSER_PASSED}"
          echo "  Whitelisted: ${PARSER_WHITELISTED}"

          if [ "$PARSER_WHITELISTED" -eq 0 ]; then
            echo "ERROR: No tests were whitelisted"
            exit 1
          fi

          SUCCESS_RATE=$(echo "scale=4; $PARSER_PASSED * 100 / $PARSER_WHITELISTED" | bc)
          echo "  Success rate: ${SUCCESS_RATE}%"

          THRESHOLD=${{ matrix.threshold }}
          PASSED=$(echo "$SUCCESS_RATE >= $THRESHOLD" | bc)

          if [ "$PASSED" -eq 1 ]; then
            echo "SUCCESS: Passed threshold (>= ${THRESHOLD}%)"
          else
            echo "FAILURE: Below threshold (expected >= ${THRESHOLD}%, got ${SUCCESS_RATE}%)"
            exit 1
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parser-results-jdk${{ matrix.jdk }}
          path: |
            build/parser_results.txt
            build/parser_jdk${{ matrix.jdk }}_results.env
          retention-days: 7

  # Compliance tests
  compliance-tests:
    name: Compliance Tests
    runs-on: ubuntu-latest
    needs: build-and-test
    strategy:
      matrix:
        include:
          - jdk: 7
            threshold: 96.5
          - jdk: 8
            threshold: 67.1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Run JDK${{ matrix.jdk }} Compliance Tests
        run: |
          nix develop --command bash ./scripts/test-java${{ matrix.jdk }}-compliance.sh --build

      - name: Check Success Threshold (${{ matrix.threshold }}%)
        run: |
          source build/compliance_jdk${{ matrix.jdk }}_results.env
          echo "JDK${{ matrix.jdk }} Compliance Results:"
          echo "  Passed: ${COMPLIANCE_PASSED}"
          echo "  Whitelisted: ${COMPLIANCE_WHITELISTED}"

          if [ "$COMPLIANCE_WHITELISTED" -eq 0 ]; then
            echo "ERROR: No tests were whitelisted"
            exit 1
          fi

          SUCCESS_RATE=$(echo "scale=4; $COMPLIANCE_PASSED * 100 / $COMPLIANCE_WHITELISTED" | bc)
          echo "  Success rate: ${SUCCESS_RATE}%"

          THRESHOLD=${{ matrix.threshold }}
          PASSED=$(echo "$SUCCESS_RATE >= $THRESHOLD" | bc)

          if [ "$PASSED" -eq 1 ]; then
            echo "SUCCESS: Passed threshold (>= ${THRESHOLD}%)"
          else
            echo "FAILURE: Below threshold (expected >= ${THRESHOLD}%, got ${SUCCESS_RATE}%)"
            exit 1
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compliance-results-jdk${{ matrix.jdk }}
          path: |
            build/compliance_jdk${{ matrix.jdk }}/results.txt
            build/compliance_jdk${{ matrix.jdk }}/failed.txt
            build/compliance_jdk${{ matrix.jdk }}_results.env
          retention-days: 7

  # OpenJDK compliance tests (run with DevJopaK)
  openjdk-compliance:
    name: OpenJDK Compliance
    runs-on: ubuntu-latest
    needs: build-devjopak
    strategy:
      matrix:
        jdk: [7, 8]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Build DevJopaK
        run: |
          nix build .#devjopak-gnucp099-jopa201 --print-build-logs

      - name: Prepare JDK${{ matrix.jdk }} Tests
        run: |
          nix develop --command python3 scripts/compliance_tester.py --prepare --jdk ${{ matrix.jdk }}

      - name: Run JDK${{ matrix.jdk }} Compliance Tests
        run: |
          # Set up paths to use built devjopak
          export DEVJOPAK_HOME="$(pwd)/result"

          nix develop --command python3 scripts/compliance_tester.py \
            --test --jdk ${{ matrix.jdk }} \
            --classpath gnucp \
            --timeout 30 \
            --mode run \
            --no-success 2>&1 | tee /tmp/jdk${{ matrix.jdk }}-compliance.log

      - name: Check Results
        run: |
          TOTAL=$(grep "^Total:" /tmp/jdk${{ matrix.jdk }}-compliance.log | awk '{print $2}')
          SUCCESS=$(grep "^Success:" /tmp/jdk${{ matrix.jdk }}-compliance.log | awk '{print $2}')
          FAILURE=$(grep "^Failure:" /tmp/jdk${{ matrix.jdk }}-compliance.log | awk '{print $2}')
          TIMEOUT=$(grep "^Timeout:" /tmp/jdk${{ matrix.jdk }}-compliance.log | awk '{print $2}')
          CRASH=$(grep "^Crash:" /tmp/jdk${{ matrix.jdk }}-compliance.log | awk '{print $2}')

          echo "## OpenJDK JDK${{ matrix.jdk }} Compliance Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "| Success | $SUCCESS |" >> $GITHUB_STEP_SUMMARY
          echo "| Failure | $FAILURE |" >> $GITHUB_STEP_SUMMARY
          echo "| Timeout | $TIMEOUT |" >> $GITHUB_STEP_SUMMARY
          echo "| Crash | $CRASH |" >> $GITHUB_STEP_SUMMARY

          if [ "$FAILURE" != "0" ] || [ "$TIMEOUT" != "0" ] || [ "$CRASH" != "0" ]; then
            echo "FAILURE: Some tests did not pass"
            exit 1
          fi

      - name: Upload test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openjdk-compliance-jdk${{ matrix.jdk }}-log
          path: /tmp/jdk${{ matrix.jdk }}-compliance.log
          retention-days: 7

  # Legacy Classpath 0.93 build
  build-legacy-classpath:
    name: Build Legacy Classpath 0.93
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Build JOPA and GNU Classpath 0.93
        run: |
          nix develop --command bash -c '
            set -euo pipefail
            cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
            cmake --build build -j$(nproc)
            cmake -S devjopak -B build-devjopak \
              -DJOPA_BUILD_DIR=build \
              -DCMAKE_BUILD_TYPE=Release \
              -DJOPA_CLASSPATH_VERSION=0.93
            cmake --build build-devjopak --target gnu_classpath -j$(nproc) 2>&1 | tee /tmp/build-legacy.log
          '

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-legacy-log
          path: /tmp/build-legacy.log
          retention-days: 7

  # Create GitHub release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-devjopak, parser-tests, compliance-tests]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/devjopak-jopa/*.tar.gz
            artifacts/devjopak-ecj421/*.tar.gz
            artifacts/devjopak-ecj422/*.tar.gz
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
