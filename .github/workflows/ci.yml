name: Jopa CI

on:
  push:
    branches: [ main, master, develop, 'wip/**' ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-release:
    name: Build and Test (Release)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14
        with:
          logger: pretty
          log-directives: nix_installer=debug

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Check flake
        run: nix flake check --show-trace

      - name: Run Primary Tests (Release, Full Matrix)
        run: |
          nix develop --command bash ./scripts/test-primary.sh --release

      - name: Generate test summary
        if: always()
        run: |
          echo '## Release Build Test Results' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo 'Full matrix: -source 1.7 with targets 1.5, 1.6' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          nix develop --command bash -c "cd build && ctest -N 2>/dev/null | tail -5" >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-release
          path: |
            build/test/*.class
            build/Testing/Temporary/LastTest.log
          retention-days: 7

  build-debug:
    name: Build and Test (Debug + Sanitizers)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14
        with:
          logger: pretty
          log-directives: nix_installer=debug

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Run Primary Tests (Debug + Sanitizers, Full Matrix)
        run: |
          nix develop --command bash ./scripts/test-primary.sh --sanitizers

      - name: Generate test summary
        if: always()
        run: |
          echo '## Debug Build Test Results (with Sanitizers)' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo 'Full matrix: -source 1.7 with targets 1.5, 1.6' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          nix develop --command bash -c "cd build && ctest -N 2>/dev/null | tail -5" >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-debug
          path: |
            build/test/*.class
            build/Testing/Temporary/LastTest.log
          retention-days: 7

  parser-tests-jdk7:
    name: JDK7 Parser Tests
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14
        with:
          logger: pretty
          log-directives: nix_installer=debug

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Run JDK7 Parser Tests
        run: |
          nix develop --command bash ./scripts/test-java7-parser.sh --build

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parser-results-jdk7
          path: |
            build/parser_results.txt
            build/parser_jdk7_results.env
          retention-days: 7

  parser-tests-jdk8:
    name: JDK8 Parser Tests
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14
        with:
          logger: pretty
          log-directives: nix_installer=debug

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Run JDK8 Parser Tests
        run: |
          nix develop --command bash ./scripts/test-java8-parser.sh --build

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parser-results-jdk8
          path: |
            build/parser_results.txt
            build/parser_jdk8_results.env
          retention-days: 7
